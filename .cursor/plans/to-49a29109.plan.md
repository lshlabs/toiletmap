<!-- 49a29109-099d-499c-8647-c011e78959c9 0c5d81ea-dc4a-43e4-a8fe-2106e1dce921 -->
# Firebase 백엔드 계획 (toiletmap)

## 개요

- **목표**: Flutter 앱을 위한 Firebase 백엔드(Cloud Firestore 중심) 구축
- **인증**: 이메일/비번, Google, 익명
- **데이터**: 화장실 정보/리뷰/즐겨찾기/신고, 이미지 업로드
- **운영**: 보안규칙, 인덱스, Functions 트리거/콜러블, 에뮬레이터, 배포

## 기술 스택/선택

- **DB**: Cloud Firestore (Native 모드)
- **파일 저장소**: Cloud Storage for Firebase
- **서버리스 로직**: Cloud Functions for Firebase (Node.js 20)
- **인증**: Firebase Authentication (Email/Pass, Google, Anonymous)
- **지오쿼리**: Geohash + 범위쿼리(Flutter 측: geoflutterfire2 또는 직접 구현)
- **로컬개발**: Firebase Emulator Suite

## 리포/디렉터리 구조(모노레포)

- `/Users/mac/Documents/toiletmap/`
  - `mobile/` (Flutter 앱; 별도 진행)
  - `infra/firebase/`
    - `functions/` (Cloud Functions 소스)
    - `firestore.rules` (보안규칙)
    - `firestore.indexes.json` (복합 인덱스)
    - `storage.rules` (스토리지 규칙)
    - `.firebaserc`, `firebase.json` (프로젝트/에뮬레이터 설정)
    - `.env`/runtime config (필요시)

## 데이터 모델(Cloud Firestore)

- `toilets` (collection)
  - `id` (doc id), `name`, `address`, `roadAddress`, `district`, `isPublic`, `openHours`, `amenities`(배열: babyBed, bidet, wheelchair, feminineProducts 등), `genderType`(unisex/male/female), `updatedAt`, `source`
  - 위치: `location`(GeoPoint), `geohash`(string)
  - 집계: `ratingAvg`(number), `ratingCount`(number)
- `toilets/{toiletId}/reviews` (subcollection)
  - `userId`, `rating`(1~5), `comment`, `images`(array), `createdAt`, `updatedAt`, `reported`(bool)
- `users` (collection)
  - `displayName`, `photoURL`, `providerIds`(array), `createdAt`, `lastLoginAt`
- `favorites` (collection) — 사용자 중심 인덱싱
  - 문서키: `${userId}_${toiletId}`
  - `userId`, `toiletId`, `createdAt`
- `reports` (collection) — 리뷰/화장실 정보 오류 신고
  - `targetType`(toilet/review), `targetRef`(DocumentReference), `reason`, `detail`, `userId`, `status`(open/resolved), `createdAt`, `resolvedAt`

## 필수 인덱스 예시(`infra/firebase/firestore.indexes.json`)

- `toilets` by `district` + `ratingAvg` desc
- `toilets` by `geohash` range + `ratingAvg`
- `reviews` by `toiletId` + `createdAt` desc (컬렉션 그룹 인덱스)

## 보안 규칙 요약(`infra/firebase/firestore.rules`)

- 인증 사용자만 쓰기 가능(익명 포함), 읽기는 대부분 공개
- 리뷰: 본인 문서만 수정/삭제, 평점 범위 검증
- 즐겨찾기: 본인 소유만 읽기/쓰기
- 신고: 인증 사용자만 생성, 운영자만 상태 변경
- 화장실 마스터 데이터는 기본적으로 읽기 전용, 운영자 롤만 쓰기
```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }
    function isAdmin() { return isSignedIn() && 'admin' in request.auth.token.roles; }

    match /toilets/{toiletId} {
      allow read: if true;
      allow write: if isAdmin();
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isSignedIn() && (request.resource.data.rating >= 1 && request.resource.data.rating <= 5);
        allow update, delete: if isOwner(resource.data.userId) || isAdmin();
      }
    }

    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }

    match /favorites/{favId} {
      allow read, write: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    match /reports/{reportId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update: if isAdmin();
    }
  }
}
```


## 스토리지 규칙 요약(`infra/firebase/storage.rules`)

- 리뷰 이미지: 인증 사용자만 업로드, 본인/관리자만 삭제
- 이미지 경로: `reviews/{toiletId}/{userId}/{uuid}.jpg`
```
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() { return request.auth != null; }
    match /reviews/{toiletId}/{userId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isSignedIn() && (request.auth.uid == userId || 'admin' in request.auth.token.roles);
    }
  }
}
```


## Cloud Functions 설계(`infra/firebase/functions/`)

- 런타임: Node.js 20, TypeScript
- 트리거
  - `onReviewWrite`: 리뷰 생성/수정/삭제 시 `ratingAvg`, `ratingCount` 집계 업데이트
  - `onReportCreate`: 신고 생성 시 Slack/Webhook 알림(옵션)
- 콜러블 API
  - `submitReview(toiletId, rating, comment, images?)`
  - `toggleFavorite(toiletId)`
  - `updateToiletAdmin(...)` — 관리자 전용
- 스케줄러
  - `nightlyReindexGeo` — 지오 인덱스 보정/캐시 (옵션)

### 집계 예시 스케치

```ts
export const onReviewWrite = functions.firestore
  .document('toilets/{toiletId}/reviews/{reviewId}')
  .onWrite(async (change, ctx) => {
    const toiletRef = db.collection('toilets').doc(ctx.params.toiletId);
    const reviewsSnap = await toiletRef.collection('reviews').get();
    const count = reviewsSnap.size;
    const avg = count ? reviewsSnap.docs.reduce((s, d) => s + (d.data().rating || 0), 0) / count : 0;
    await toiletRef.update({ ratingCount: count, ratingAvg: Number(avg.toFixed(2)) });
  });
```

## 인증 구성

- 활성화: Email/Password, Google, Anonymous
- Flutter 플러그인: `firebase_auth`, `google_sign_in`
- 사용자 문서 동기화: 첫 로그인 시 `users/{uid}` upsert

## 지오쿼리 전략

- 문서에 `location(GeoPoint)` + `geohash` 저장
- Flutter: 현재 위치 중심 반경 N m 검색
  - 옵션 1: `geoflutterfire2` 사용
  - 옵션 2: 경도/위도 범위 계산 + geohash prefix 범위 쿼리

## 로컬 개발/테스트

- Firebase Emulator Suite: Auth/Firestore/Storage/Functions 통합 실행
- 시드 스크립트(Functions 또는 Node 스크립트)로 예시 화장실 N개 생성
- Flutter는 에뮬레이터 호스트에 연결

## 배포/운영

- 프로젝트: `toiletmap-dev`, `toiletmap-prod` (2개 환경)
- 설정: `firebase use` 별도 alias(`dev`, `prod`)
- Secret/Config: Functions env config 사용(예: Slack webhook)
- 모니터링: Crashlytics(앱), Functions logs, Firestore usage 대시보드
- 비용 제어: 읽기 최적화(필드 마스킹, 페이지네이션), 인덱스 최소화

## Flutter 연동 포인트(참고)

- 지도: `google_maps_flutter` or `flutter_map`
- 데이터: `cloud_firestore`, 스트림 기반 near-by 쿼리
- 상태관리: Riverpod/Bloc 중 팀 선호
- 업로드: `image_picker` + Storage putFile → 다운로드 URL 저장

### 완료 현황 요약

**dev 환경:**

- ✅ Firestore 생성 (서울 리전: asia-northeast3)
- ✅ Storage 생성 (서울 리전: asia-northeast3)
- ✅ Firestore 규칙/인덱스 배포 완료
- ✅ Storage 규칙 배포 완료 (콘솔)
- ✅ Cloud Functions 배포 완료 (5개: onReviewWrite, onReportCreate, submitReview, toggleFavorite, updateToiletAdmin)
- ✅ 인증 제공자 활성화 (Email/Password, Google, Anonymous)

**prod 환경:**

- ✅ Firestore 생성 (서울 리전: asia-northeast3)
- ✅ Storage 생성 (서울 리전: asia-northeast3)
- ✅ Firestore 규칙/인덱스 배포 완료
- ✅ Storage 규칙 배포 완료 (콘솔)
- ✅ Cloud Functions 배포 완료 (5개)
- ✅ 인증 제공자 활성화 (Email/Password, Google, Anonymous)

**기본 Firebase 백엔드 설정 완료** ✅

### To-dos

- [x] Firebase 프로젝트 2개(dev/prod) 생성 및 콘솔 기본 설정
- [x] infra/firebase 초기화(firebase init)와 에뮬레이터 설정 작성
- [x] 컬렉션/필드 스키마와 표준 문서 형식 확정 및 문서화
- [x] Firestore 보안규칙 초안 작성 및 에뮬레이터에서 테스트
- [x] Storage 보안규칙 초안 작성 및 에뮬레이터에서 테스트
- [x] Cloud Functions TypeScript 부트스트랩 및 기본 트리거 구현
- [x] 필수 복합 인덱스 정의 및 배포
- [x] Auth(Email/Google/Anonymous) 콘솔 설정 및 테스트
- [ ] 에뮬레이터 실행 및 초기 데이터 시딩/시나리오 테스트
- [x] Flutter 패키지/초기화/지오쿼리 예제 가이드 작성
- [ ] 운영 환경 분리, 최소 권한, 로그/알림/비용 가드 설정